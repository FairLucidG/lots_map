{% extends "base.html" %}
{% block title %}Настройки{% endblock %}
{% block content %}

    <h1 class="shadow-sm mt-1 mb-3 p-2 rounded">Управление регионами</h1>

    <h2>Обновить регионы из файла:</h2>

    <form id="uploadForm" class="mt-4 mb-4" enctype="multipart/form-data">
        <div class="input-group mb-3">
            <input type="file" id="fileInput" class="form-control" accept=".xls,.xlsx">
            <button id="uploadButton" class="btn btn-primary">Обновить</button>
        </div>
    </form>
    <div id="progress" class="d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
        <p class="mt-2">Отправка файла...</p>
    </div>
    <div id="result" class="mt-3"></div>

    <!-- Таблица с регионами -->
    <div class="mt-5">
        <h2>Список регионов</h2>
        <div class="table-responsive">
        <table class="table table-sm table-striped table-bordered text-center">
            <thead class="table-light align-middle">
                <tr>
                    <th scope="col">Код региона</th>
                    <th scope="col">Федеральный округ</th>
                    <th scope="col">Регион</th>
                </tr>
            </thead>
            <tbody id="regionsTableBody" class="align-middle">
                {% for region in regions.items %}
                <tr>
                    <td>{{ region.region_code }}</td>
                    <td>{{ region.federal_district }}</td>
                    <td>{{ region.region_name }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center" id="pagination">
                {% if regions.has_prev %}
                <li class="page-item"><a class="page-link" href="?page={{ regions.prev_num }}">«</a></li>
                {% else %}
                <li class="page-item disabled"><a class="page-link" href="#">«</a></li>
                {% endif %}
                {% for page_num in regions.iter_pages() %}
                {% if page_num %}
                {% if page_num != regions.page %}
                <li class="page-item"><a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a></li>
                {% else %}
                <li class="page-item active" aria-current="page"><span class="page-link">{{ page_num }}</span></li>
                {% endif %}
                {% else %}
                <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
                {% endif %}
                {% endfor %}
                {% if regions.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ regions.next_num }}">»</a></li>
                {% else %}
                <li class="page-item disabled"><a class="page-link" href="#">»</a></li>
                {% endif %}
            </ul>
        </nav>
    </div>

    <script>

        function reloadPageWithTimer(seconds) {
            var messageElement = document.getElementById('reloadMessage');
            messageElement.innerText = " Страница будет перезагружена через " + seconds + " секунд.";
            if (seconds === 0) {
                location.reload();
            } else {
                setTimeout(function() {
                    reloadPageWithTimer(seconds - 1);
                }, 1000);
            }
        }

        document.getElementById('uploadButton').addEventListener('click', function(event) {

            event.preventDefault();

            var fileInput = document.getElementById('fileInput');
            var file = fileInput.files[0];
            var formData = new FormData();
            formData.append('file', file);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '{{ url_for('api.update_lots_trade_gov_regions') }}', true);
            xhr.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    var percentComplete = (e.loaded / e.total) * 100;
                    document.getElementById('progress').classList.remove('d-none');
                    document.getElementById('progress').innerHTML = '<div class="spinner-border text-primary" role="status">' +
                        '<span class="visually-hidden"Загрузка...</span></div><p class="mt-2">Отправка файла... ' + percentComplete.toFixed(2) + '%</p>';
                }
            };
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    if (response.error) {
                        document.getElementById('result').innerHTML = '<div class="alert alert-danger" role="alert">' + response.error + '</div>';
                    } else if (response.success) {
                        document.getElementById('result').innerHTML = '<div class="alert alert-success" role="alert">' + response.success
                         + '<span id="reloadMessage"></span></div>';
                        reloadPageWithTimer(5);
                    }
                }
                document.getElementById('progress').classList.add('d-none');
            };
            xhr.send(formData);
        });
    </script>

{% endblock %}
